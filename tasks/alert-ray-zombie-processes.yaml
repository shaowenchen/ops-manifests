apiVersion: crd.chenshaowen.com/v1
kind: Task
metadata:
    name: alert-mount-timeout
    namespace: ops-system
spec:
    desc: check mount response timeout
    host: "alert-gpu=enabled"
    variables:
        threshold:
            default: "5"
    steps:
        - name: alert-mount-timeout
          content: |
              #!/usr/bin/python
              import subprocess
              import requests
              import json
              import os

              TIMEOUT_SECONDS = int(${threshold})

              def send(status, message):
                  payload = {
                      'host': '${HOSTNAME}',
                      'type': 'TaskRunReport',
                      'kind': '${TASKRUN}',
                      'status': status,
                      'message': message
                  }
                  headers = {
                      'Content-Type': 'application/json'
                  }
                  try:
                      response = requests.post(
                          '${OPSSERVER_ENDPOINT}/api/v1/namespaces/${NAMESPACE}/events/taskruns.${TASKRUN}.reports.${HOSTNAME}',
                          headers=headers,
                          data=json.dumps(payload)
                      )
                      print(response.text)
                  except Exception as e:
                      print(f"Failed to send alert: {str(e)}")

              try:
                  # 执行 df -h，限制超时时间
                  cmd = f"timeout {TIMEOUT_SECONDS} df -h"
                  result = subprocess.check_output(cmd, shell=True).decode('utf-8').strip()
                  
                  # 正常返回就发送 normal 状态
                  send('normal', f'df -h executed successfully within {TIMEOUT_SECONDS} seconds:\n{result}')

              except subprocess.CalledProcessError as e:
                  # df -h 返回非 0 或被 timeout 杀掉，可能是超时
                  send('alerting', f'df -h command failed or timed out after {TIMEOUT_SECONDS} seconds:\n{str(e)}')

              except Exception as e:
                  # 其他异常
                  send('alerting', f'Unexpected error: {str(e)}')
