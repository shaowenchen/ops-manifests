apiVersion: crd.chenshaowen.com/v1
kind: Task
metadata:
  name: inspect-pod-process
  namespace: ops-system
spec:
  desc: inspect pod process
  variables:
    pod:
      required: true
  steps:
    - name: inspect-pod-process
      content: |
        POD_NAME="${pod}"

        echo "üîç [1/5] Finding container ID for Pod [$POD_NAME] ..."
        CONTAINER_IDS=$(nerdctl -n k8s.io ps -a | grep "$POD_NAME" | grep -v "pause" | awk '{print $1}')
        
        if [ -z "$CONTAINER_IDS" ]; then
          echo "‚ùå Container not found, please verify Pod name: [$POD_NAME]"
          echo "All related containers (including pause containers):"
          nerdctl -n k8s.io ps -a | grep "$POD_NAME" || echo "No containers found"
          exit 1
        fi

        # Get the first container ID (usually the main container)
        CONTAINER_ID=$(echo "$CONTAINER_IDS" | head -1)
        
        echo "‚úÖ Found application container count: $(echo "$CONTAINER_IDS" | wc -l)"
        echo "‚úÖ Application container IDs:"
        echo "$CONTAINER_IDS"
        echo "‚úÖ Using first application container ID: $CONTAINER_ID"

        echo "üîç [2/5] Getting container main process PID on host ..."
        INSPECT_OUTPUT=$(nerdctl -n k8s.io inspect "$CONTAINER_ID" 2>/dev/null)
        
        if [ $? -ne 0 ]; then
          echo "‚ùå Cannot inspect container [$CONTAINER_ID], container may not exist or has stopped"
          exit 1
        fi
        
        PID=$(echo "$INSPECT_OUTPUT" | grep -i '"Pid"' | grep -o '[0-9]\+' | head -1)

        if [ -z "$PID" ] || [ "$PID" -eq 0 ]; then
          echo "‚ùå No valid host PID found"
          echo "Container status information:"
          echo "$INSPECT_OUTPUT" | head -20
          exit 1
        fi

        echo "‚úÖ Host PID: $PID"

        # Verify if the process still exists
        if ! ps -p "$PID" >/dev/null 2>&1; then
          echo "‚ùå Process [$PID] no longer exists, container may have stopped"
          exit 1
        fi

        echo "üîç [3/5] Finding parent process (PPID) on host ..."
        PPID=$(ps -o ppid= -p "$PID" | tr -d ' ')
        echo "‚úÖ Parent process PPID: $PPID"

        echo "üîç [4/5] Checking GPU usage ..."
        if command -v nvidia-smi &>/dev/null; then
          GPU_PROCS=$(timeout 10 nvidia-smi pmon -c 1 | grep "$PID" || true)
          if [ -n "$GPU_PROCS" ]; then
            echo "‚úÖ GPU usage information:"
            echo "$GPU_PROCS"
          else
            echo "‚úÖ No GPU usage detected"
          fi
        else
          echo "‚ö†Ô∏è  nvidia-smi not installed, skipping GPU check"
        fi

        echo "üîç [5/5] Viewing mounted storage information ..."
        echo "‚úÖ Container host process mount points:"
        echo "-------------------------------------------------"
        cat /proc/$PID/mounts
        echo "-------------------------------------------------"
