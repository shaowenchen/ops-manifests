name: Release

on:
  push:
    branches:
      - main
      - 'v*.*'
  workflow_dispatch:
    inputs:
      branch_name:
        description: "Branch name (e.g., main, v2.0)"
        required: true
        type: string
        default: main

jobs:
  update-tag:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Determine tag name
        id: tag
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            BRANCH_NAME="${{ github.event.inputs.branch_name }}"
          else
            BRANCH_NAME="${GITHUB_REF#refs/heads/}"
          fi
          
          if [ "$BRANCH_NAME" == "main" ]; then
            TAG_NAME="latest"
          elif [[ "$BRANCH_NAME" =~ ^v[0-9]+\.[0-9]+$ ]]; then
            TAG_NAME="${BRANCH_NAME}.0"
          else
            echo "Error: Invalid branch name format. Expected 'main' or 'vx.x'"
            exit 1
          fi
          
          echo "branch_name=$BRANCH_NAME" >> $GITHUB_OUTPUT
          echo "tag_name=$TAG_NAME" >> $GITHUB_OUTPUT
          echo "Branch: $BRANCH_NAME -> Tag: $TAG_NAME"

      - name: Delete existing tag if exists
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
            echo "Tag $TAG_NAME exists, deleting..."
            git tag -d "$TAG_NAME" || true
            git push origin ":refs/tags/$TAG_NAME" || true
          else
            echo "Tag $TAG_NAME does not exist, will create new one"
          fi

      - name: Create and push tag
        run: |
          TAG_NAME="${{ steps.tag.outputs.tag_name }}"
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "$TAG_NAME" -m "Update $TAG_NAME tag from ${{ steps.tag.outputs.branch_name }} branch"
          git push origin "$TAG_NAME"
          echo "Successfully created/updated tag: $TAG_NAME"